  clear
  clf
  xPts = 101;                                                               % Number of x points. Odd
  L = 1.5;
  dx = L/xPts;
  dt   = 0.00001;                                                              % Time step.
  m    = 1/1000;                                                             % Mass density.
  mid = (xPts+1)/2;
  
  %initial conditions
  cVec = [0.000138863203212978;0.000134219890068621;0.000129583749811883;0.000124961713315474;0.000120360393684523;0.000115786170678030;0.000111245158931177;0.000106743198416077;0.000102285915937290;9.78787033980418e-05;9.35266998985131e-05;8.92348311550418e-05;8.50078006579633e-05;8.08500967705603e-05;7.67659978722339e-05;7.27595713995527e-05;6.88346868911795e-05;6.49950126382639e-05;6.12440277458004e-05;5.75850169206831e-05;5.40210806626365e-05;5.05551362450403e-05;4.71899230219361e-05;4.39280039892650e-05;4.07717699473535e-05;3.77234435529422e-05;3.47850815264685e-05;3.19585788269220e-05;2.92456705846884e-05;2.66479366477562e-05;2.41668036590001e-05;2.18035486019906e-05;1.95593014820953e-05;1.74350486389645e-05;1.54316354748383e-05;1.35497696110922e-05;1.17900235764865e-05;1.01528375338143e-05;8.63852313128834e-06;7.24726461458908e-06;5.97912368065050e-06;4.83404179181871e-06;3.81184004466344e-06;2.91222728345843e-06;2.13479873338932e-06;1.47904121584191e-06;9.44332150299571e-07;5.29948153978055e-07;2.35064299532184e-07;5.87549917087371e-08;0;5.76872006448348e-08;2.32929373560065e-07;5.26746309580800e-07;9.40062789649837e-07;1.47370350509456e-06;2.12839438573989e-06;2.90475537245705e-06;3.80330079946103e-06;4.82443420240456e-06;5.96844973256919e-06;7.23552295878865e-06;8.62571385480335e-06;1.01389603554373e-05;1.17750795733292e-05;1.35337581159446e-05;1.54145570538701e-05;1.74169013879739e-05;1.95400865244007e-05;2.17832675311509e-05;2.41454554485328e-05;2.66255191369753e-05;2.92221870526084e-05;3.19340277507192e-05;3.47594644980083e-05;3.76967569300120e-05;4.07440168815505e-05;4.38991832612708e-05;4.71600346854846e-05;5.05241805248309e-05;5.39890570695652e-05;5.75519271579679e-05;6.12098693045966e-05;6.49597881940585e-05;6.87983942947064e-05;7.27222116678923e-05;7.67275710058142e-05;8.08106027643425e-05;8.49672387487517e-05;8.91932005618497e-05;9.34840010326683e-05;9.78349370682370e-05;0.000102241085243444;0.000106697295617259;0.000111198187503121;0.000115738142392036;0.000120311299283877;0.000124911546723745;0.000129532516955095;0.000134167577578410;0.000138809823788302;0.000846992856264006;0.000821446067928236;0.000795899278494105;0.000770352486908233;0.000744805692158152;0.000719258893270593;0.000693748485708213;0.000668309576604865;0.000642976051982091;0.000617780639371669;0.000592754966228284;0.000567929614479287;0.000543334171526905;0.000518997277986774;0.000494946672418296;0.000471209233281802;0.000447811018333192;0.000424777301648938;0.000402132608456899;0.000379900747933497;0.000358104844112928;0.000336767365042878;0.000315910150309071;0.000295554437041123;0.000275720884503238;0.000256429597364452;0.000237700147736063;0.000219551596056757;0.000202002510899762;0.000185070987770695;0.000168774666959614;0.000153130750505962;0.000138156018330887;0.000123866843587334;0.000110279207274844;9.74087121624395e-05;8.52705960601881e-05;7.38797444769965e-05;6.32507026997757e-05;5.33976873266003e-05;4.43345972844408e-05;3.60750243598761e-05;2.86322632694747e-05;2.20193212945938e-05;1.62489275041072e-05;1.13335415866161e-05;7.28536231275827e-06;4.11633564680665e-06;1.83816252524523e-06;4.62306319782635e-07;0;4.62253011110550e-07;1.83805590789443e-06;4.11617572075782e-06;7.28514907803516e-06;1.13332750431898e-05;1.62486076519631e-05;2.20189481337178e-05;2.86318367998614e-05;3.60745445814995e-05;4.43340641972715e-05;5.33971009306081e-05;6.32500629949662e-05;7.38790514633244e-05;8.52698497376169e-05;9.74079125309509e-05;0.000110278354334392;0.000123865937337858;0.000138155058772353;0.000153129737638330;0.000168773600782872;0.000185069868284748;0.000202001338104584;0.000219550369952276;0.000237698868322239;0.000256428264641239;0.000275719498470580;0.000295552997698969;0.000315908657657348;0.000336765819081559;0.000358103244841947;0.000379899095352790;0.000402130902566428;0.000424775542448614;0.000447809205822997;0.000471207367461628;0.000494944753288095;0.000518995305546514;0.000543332145776521;0.000567927535418668;0.000592752833857493;0.000617778453690628;0.000642973812990704;0.000668307284303141;0.000693746140095991;0.000719256494347690;0.000744803239925032;0.000770349981364953;0.000795896719639996;0.000821443455763088;0.000846990190788752;];
  rVec = [-1.87224610995396e-16;-3.30786730057164e-12;-2.24724099531369e-11;4.01904154996178e-11;1.05515883490941e-10;9.30372762880140e-13;-2.22787146871473e-11;-9.01734922354510e-11;-1.10745807543975e-10;-7.46930791482446e-11;-7.04974264389784e-11;4.31467284250637e-11;1.12703422047960e-10;-4.36776668367891e-11;-9.80526426247680e-11;-1.69498941588624e-10;-1.50010671961555e-10;7.19193732481383e-11;4.90354184123562e-11;-3.73919643620498e-11;-2.30534115153733e-11;4.08012112865317e-11;1.97292880329322e-10;2.63783826352044e-10;-8.94713852160091e-11;1.32202516728991e-10;-6.02230789922050e-11;-2.15259724650231e-11;9.98554430331824e-11;6.13354586033715e-11;6.44512198060172e-11;-5.18601791827007e-11;-1.16298985686995e-10;7.65217226064187e-11;9.86204866143710e-11;-8.29445518345240e-12;-6.78931034114004e-11;3.02471279902024e-11;-2.08068015562172e-10;6.00770095563613e-11;4.54693481217322e-11;-4.80032759419061e-11;7.73088802176469e-11;-2.23744500574621e-11;-1.85586587330561e-11;2.01595816862882e-11;-1.67240320984169e-12;7.20655447209589e-12;-3.71625537417750e-11;-3.12902323409275e-11;-3.76327356863687e-11;-6.05724400758873e-12;2.23870513056321e-11;-1.81995921154712e-11;-1.49065678420671e-11;-1.48857884569101e-11;-8.20683636066494e-12;-1.20589816344358e-11;-1.68815471584399e-11;-5.10757517009630e-12;-2.19640629468831e-11;7.69523767624181e-13;-1.19783015971320e-11;-2.75028979625225e-12;8.88611580152077e-12;9.17275587083988e-13;7.01488476681500e-12;1.58665387686024e-11;1.49453431401436e-11;-6.52592368165228e-12;8.57727127170915e-12;5.94901797094927e-12;3.14754103857007e-12;-7.39040989863882e-13;-2.02692593612164e-12;-2.98649061210299e-12;-3.07789362573307e-12;-7.44722642928575e-13;-8.34349950240565e-13;1.36288094525205e-12;8.85102971817653e-13;2.06962919024889e-13;2.92512325125727e-13;-1.95851126115476e-12;5.33951572193048e-13;1.53728614039894e-12;4.03221510000829e-13;3.52591220109666e-14;1.81264291770900e-13;3.55048022232518e-14;1.17830658424856e-13;-6.71181860090186e-14;3.42939652370200e-14;-3.32487943427440e-14;1.09230116271397e-14;-2.66149949301742e-14;-2.48412401759879e-15;-6.27536217434610e-15;-3.33001855257198e-15;3.99680288865056e-15;0;-1.69909023257165e-18;-0.00180194456917740;-0.00359996877946229;-0.00539030161897191;-0.00716931304831092;-0.00893350624032737;-0.0106813283706023;-0.0124112815817571;-0.0141219201157762;-0.0158118476425007;-0.0174797147671106;-0.0191242167027280;-0.0207440910948473;-0.0223381159839777;-0.0239051078978705;-0.0254439200609780;-0.0269534407135857;-0.0284325915327688;-0.0298803261455125;-0.0312956287302472;-0.0326775126970926;-0.0340250194452503;-0.0353372171872712;-0.0366131998406438;-0.0378520859779137;-0.0390530178343277;-0.0402151603671504;-0.0413377003648335;-0.0424198456022618;-0.0434608240380305;-0.0444598830532369;-0.0454162887277894;-0.0463293251515870;-0.0471982937702556;-0.0480225127609642;-0.0488013164389084;-0.0495340546907948;-0.0502200924348154;-0.0508588091053545;-0.0514495981609144;-0.0519918666138635;-0.0524850345814093;-0.0529285348557132;-0.0533218124929829;-0.0536643244197531;-0.0539555390562795;-0.0541949359553346;-0.0543820054561420;-0.0545162483525224;-0.0545971755745197;-0.0546243078826509;-0.0545971755745534;-0.0545162483526045;-0.0543820054562457;-0.0541949359554697;-0.0539555390564727;-0.0536643244199783;-0.0533218124932349;-0.0529285348560089;-0.0524850345817141;-0.0519918666141957;-0.0514495981612692;-0.0508588091057694;-0.0502200924352542;-0.0495340546912524;-0.0488013164393973;-0.0480225127614573;-0.0471982937707453;-0.0463293251521281;-0.0454162887283069;-0.0444598830538092;-0.0434608240385718;-0.0424198456028313;-0.0413377003654400;-0.0402151603676662;-0.0390530178348595;-0.0378520859784781;-0.0366131998411603;-0.0353372171877931;-0.0340250194457342;-0.0326775126976656;-0.0312956287307328;-0.0298803261461042;-0.0284325915333013;-0.0269534407141305;-0.0254439200614265;-0.0239051078983431;-0.0223381159844076;-0.0207440910951981;-0.0191242167031094;-0.0174797147674447;-0.0158118476428555;-0.0141219201160822;-0.0124112815819589;-0.0106813283707926;-0.00893350624051167;-0.00716931304842916;-0.00539030161909891;-0.00359996877953503;-0.00180194456920927;0;];
  
  % Set force function.
  q    = zeros(xPts, 1);                                                   % No force on most of it.
  q(5) = 40;
  q(end-4) = 40;
  q((end+1)/2) = -80;

  % Difference operator. 
  % Using second order coefficients for second derivative.

  d2Coeffs2 = [0 0 0 1 -2 1 0 0 0];  
  d1Coeffs1 = [0 0 0 -1 0 1 0 0 0];  
  d2Coeffs8 = [-1/560 8/315 -1/5 8/5 -205/72 8/5 -1/5 8/315 -1/560];
  dTwo = zeros(xPts,xPts);
  dOne = zeros(xPts,xPts);

  for count = -4:4
    % Add an offset diagonal matrix for each step to build banded matrix.
    dTwo = dTwo + ...
            d2Coeffs2(count + 5) * diag( ones( 1, xPts - abs(count) ), count);
    dOne = dOne + ...
            d1Coeffs1(count + 5) * diag( ones( 1, xPts - abs(count) ), count);
  end
  dTwo(1,:) = 0;
  dTwo(1,1) = 0;
  dTwo(end,:) = 0;
  dTwo(end,end) = 0;
  E = 1E9;
  I = [1:2/xPts:2];
  I = [I fliplr(I(1:end-1))];
  EI = diag(E.*I);
  
  %Euler-Bernoulli operator
  EBOp = dTwo*EI*dTwo;
  
  %Make HUGE MATRIX. Presently a huge operator such that 
  %Tfwd U(x,t) = U(x,t+1)
  M1 =  -10*dt/m*EBOp;                                      % map v to v stepping backwards
  M2 = -EBOp/m;                                                            % map w to v
  M3 = eye(xPts);                                                          % map w to w
  M4 = zeros(xPts,xPts);                                                   % map v to w
  
  Tfwd = [M1 M2;...
          M3 M4];
  Tcrank = (eye(2*xPts) - Tfwd * dt)^-1;
  
cphi = zeros(xPts,1);
X = cphi;
Y = cphi;

  hold off;
  fin = 10000;
  for count = 1:fin;
      
    dw = cVec(xPts+2:end) - cVec(xPts+1:end-1);
    dphi = atan(dw/dx);
    
    for count2 = 1:mid - 1
      cphi(mid - count2) = cphi(mid - count2 + 1) + dphi(mid - count2);
      cphi(mid + count2) = cphi(mid + count2 - 1) + dphi(mid + count2 -1);
      
      X(mid - count2) = X(mid - count2 + 1) + cos(cphi(mid - count2));
      X(mid + count2) = X(mid + count2 - 1) - cos(cphi(mid + count2));
      
      Y(mid - count2) = Y(mid - count2 + 1) - sin(cphi(mid - count2));
      Y(mid + count2) = Y(mid + count2 - 1) + sin(cphi(mid + count2));   
    end
    cphi = abs(cphi);
    
   %F = [q/m*dt; zeros(xPts,1)].*cos([cphi; zeros(xPts,1)]);
   F = [q/m*dt; zeros(xPts,1)];%*cos(cphi(5));
    cVec = Tcrank * (cVec + F);         %CRANK
    cVec(xPts+1:2*xPts) = cVec(xPts+1:2*xPts) - cVec(mid+xPts);             %move back
    cVec(1:xPts) = cVec(1:xPts) - cVec(mid);                                %decelerate
    
    %cVec = setBoundaries(cVec,xPts);
    
    if mod(count, fin/100) == 0
        clc
        pc = count*100/fin
        hold off;
       figure(1)
        plot(cVec(xPts+1:2*xPts));
        axis([0 xPts -1E-3 1E-2])
%         figure(2)
%         plot(F(1:xPts))
%         figure(3)
%         plot(dphi)
%         axis([0 xPts -0.1 0.1])
%          figure(4)
        plot(cphi)
        axis([0 xPts -0.1 3])
        figure(5)
        plot(X,Y)
        axis([-mid mid -15 50])
    end
  end
